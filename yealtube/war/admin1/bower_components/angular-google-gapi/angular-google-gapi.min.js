/**
 * An AngularJS module for use all Google Apis and your Google Cloud Endpoints
 * @version 1.0.0-SNAPSHOT
 * @link https://github.com/maximepvrt/angular-google-gapi
 */
angular.module("angular-google-gapi",["ngCookies"]),angular.module("angular-google-gapi").factory("GClient",["$document","$q","$window",function($document,$q,$window){function loadScript(src){var deferred=$q.defer();$window._gapiOnLoad=function(){deferred.resolve()};var script=$document[0].createElement("script");return script.onerror=function(e){$timeout(function(){deferred.reject(e)})},script.src=src,$document[0].body.appendChild(script),deferred.promise}var LOAD_GAE_API=!1,LOADING_GAE_API=!1,URL="https://apis.google.com/js/client.js?onload=_gapiOnLoad",API_KEY=null,OBSERVER_CALLBACKS=[];return{get:function(){var deferred=$q.defer();return LOAD_GAE_API?deferred.resolve():LOADING_GAE_API?OBSERVER_CALLBACKS.push(deferred):(LOADING_GAE_API=!0,loadScript(URL).then(function(){$window.gapi.client.setApiKey(API_KEY),LOAD_GAE_API=!0,LOADING_GAE_API=!1,deferred.resolve();for(var i=0;i<OBSERVER_CALLBACKS.length;i++)OBSERVER_CALLBACKS[i].resolve()})),deferred.promise},setApiKey:function(apiKey){API_KEY=apiKey,LOAD_GAE_API&&$window.gapi.client.setApiKey(API_KEY)},getApiKey:function(){return API_KEY}}}]),angular.module("angular-google-gapi").factory("GData",["$rootScope","$cookies",function($rootScope,$cookies){$rootScope.gapi={};var isLogin=!1,user=null;return{isLogin:function(value){return 0==arguments.length?isLogin:(isLogin=value,void($rootScope.gapi.login=value))},getUser:function(value){return 0==arguments.length?user:(user=value,void(null!==value?$cookies.put("userId",value.id):$cookies.remove("userId")))}}}]),angular.module("angular-google-gapi").factory("GAuth",["$rootScope","$q","GClient","GApi","GData","$interval","$cookies","$window","$location","$q",function($rootScope,$q,GClient,GApi,GData,$interval,$cookies,$window,$location,$q){function load(){var deferred=$q.defer();return 0==isLoad?GClient.get().then(function(){$window.gapi.client.load("oauth2","v2",function(){isLoad=!0,deferred.resolve()})}):deferred.resolve(),deferred.promise}function signin(mode,authorizeCallback){load().then(function(){var config={client_id:CLIENT_ID,scope:SCOPE,immediate:!1,authuser:-1,response_type:RESPONSE_TYPE};mode?(config.user_id=$cookies.get("userId"),config.immediate=!0):config.immediate=!1,void 0!=DOMAIN&&(config.hd=DOMAIN),$window.gapi.auth.authorize(config,authorizeCallback)})}function offline(){function getCode(event){if("https://accounts.google.com"===event.origin){var data=JSON.parse(event.data);$window.removeEventListener("message",getCode),data=gup(data.a[0],"code"),void 0==data?deferred.reject():deferred.resolve(data)}}function gup(url,name){name=name.replace(/[[]/,"[").replace(/[]]/,"]");var regexS=name+"=([^&#]*)",regex=new RegExp(regexS),results=regex.exec(url);return null==results?void 0:results[1]}var deferred=$q.defer(),origin=$location.protocol+"//"+$location.hostname;""!=$location.port&&(origin=origin+":"+$location.port);$window.open("https://accounts.google.com/o/oauth2/auth?scope="+encodeURI(SCOPE)+"&redirect_uri=postmessage&response_type=code&client_id="+CLIENT_ID+"&access_type=offline&approval_prompt=force&origin="+origin,null,"width=800, height=600");return $window.addEventListener("message",getCode),deferred.promise}function getUser(){var deferred=$q.defer();return $window.gapi.client.oauth2.userinfo.get().execute(function(resp){if(resp.code)deferred.reject();else{GData.isLogin(!0),GApi.executeCallbacks();var user={};user.email=resp.email,user.picture=resp.picture,user.id=resp.id,resp.name&&0!==resp.name.length?user.name=resp.name:user.name=resp.email,user.link=resp.link,GData.getUser(user),deferred.resolve(user)}}),deferred.promise}var CLIENT_ID,isLoad=!1,DOMAIN=void 0,SCOPE="https://www.googleapis.com/auth/userinfo.email",RESPONSE_TYPE="token id_token";return{setClient:function(client){CLIENT_ID=client},setDomain:function(domain){DOMAIN=domain},setScope:function(scope){SCOPE=scope},checkAuth:function(){var deferred=$q.defer();return signin(!0,function(){getUser().then(function(user){deferred.resolve(user)},function(){deferred.reject()})}),deferred.promise},login:function(){var deferred=$q.defer();return signin(!1,function(){getUser().then(function(user){deferred.resolve()},function(){deferred.reject()})}),deferred.promise},setToken:function(token){var deferred=$q.defer();return load().then(function(){$window.gapi.auth.setToken(token),getUser().then(function(){deferred.resolve()},function(){deferred.reject()})}),deferred.promise},getToken:function(){var deferred=$q.defer();return load().then(function(){deferred.resolve($window.gapi.auth.getToken())}),deferred.promise},logout:function(){var deferred=$q.defer();return load().then(function(){$window.gapi.auth.setToken(null),GData.isLogin(!1),GData.getUser(null),deferred.resolve()}),deferred.promise},offline:function(){var deferred=$q.defer();return offline().then(function(code){deferred.resolve(code)},function(){deferred.reject()}),deferred.promise}}}]),angular.module("angular-google-gapi").factory("GApi",["$q","GClient","GData","$window",function($q,GClient,GData,$window){function registerObserverCallback(api,method,params,auth,deferred){var observerCallback={};observerCallback.api=api,observerCallback.apiLoad=!1,observerCallback.method=method,observerCallback.params=params,observerCallback.auth=auth,observerCallback.deferred=deferred,observerCallbacks.push(observerCallback)}function load(api,version,url){GClient.get().then(function(){$window.gapi.client.load(api,version,function(){console.log(api+" "+version+" api loaded"),apisLoad.push(api),executeCallbacks(api)},url)})}function executeCallbacks(api){for(var apiName=api,i=0;i<observerCallbacks.length;i++){var observerCallback=observerCallbacks[i];observerCallback.api!=apiName&&!observerCallback.apiLoad||0!=observerCallback.auth&&1!=GData.isLogin()?observerCallback.api==apiName&&(observerCallbacks[i].apiLoad=!0):(runGapi(observerCallback.api,observerCallback.method,observerCallback.params,observerCallback.deferred),i>-1&&observerCallbacks.splice(i--,1))}}function createRequest(api,method,params){for(var pathMethod=method.split("."),api=$window.gapi.client[api],i=0;i<pathMethod.length;i++)api=api[pathMethod[i]];return api(params)}function runGapi(api,method,params,deferred){createRequest(api,method,params).execute(function(response){response.error?deferred.reject(response):deferred.resolve(response)})}function execute(api,method,params,auth){var deferred=$q.defer();return apisLoad.indexOf(api)>-1?runGapi(api,method,params,deferred):registerObserverCallback(api,method,params,auth,deferred),deferred.promise}var apisLoad=[],observerCallbacks=[];return{executeCallbacks:function(){executeCallbacks()},load:load,createRequest:createRequest,execute:function(api,method,params){return 3==arguments.length?execute(api,method,params,!1):2==arguments.length?execute(api,method,null,!1):void 0},executeAuth:function(api,method,params){return 3==arguments.length?execute(api,method,params,!0):2==arguments.length?execute(api,method,null,!0):void 0}}}]);
